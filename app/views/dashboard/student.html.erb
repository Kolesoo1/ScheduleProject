<!-- app/views/dashboard/student.html.erb -->
<div class="container mt-4">
  <h1>Личный кабинет студента</h1>

  <div class="student-info card mb-4">
    <div class="card-body">
      <h2>Добро пожаловать, <%= current_user.full_name %>!</h2>
      <p><strong>Группа:</strong> <%= current_user.student_profile.group if current_user.student_profile %></p>
    </div>
  </div>

  <div class="my-courses card mb-4">
    <div class="card-body">
      <h3>Мои курсы</h3>

      <% if @enrollments.any? %>
        <table class="table">
          <thead>
          <tr>
            <th>Курс</th>
            <th>Преподаватель</th>
            <th>Предмет</th>
            <th>Статус</th>
            <th>Действия</th>
          </tr>
          </thead>
          <tbody>
          <% @enrollments.each do |enrollment| %>
            <tr>
              <td><%= link_to enrollment.course.name, enrollment.course %></td>
              <td><%= enrollment.course.teacher.full_name %></td>
              <td><%= enrollment.course.subject.name %></td>
              <td><span class="badge bg-success"><%= enrollment.status %></span></td>
              <td>
                <%= link_to 'Просмотр', enrollment.course, class: 'btn btn-sm btn-primary' %>
                <%= link_to 'Отписаться', course_enrollment_path(enrollment.course, enrollment),
                            method: :delete,
                            data: { confirm: 'Вы уверены?' },
                            class: 'btn btn-sm btn-danger' %>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
      <% else %>
        <p>Вы еще не записаны на курсы.</p>
        <%= link_to 'Посмотреть доступные курсы', courses_path, class: 'btn btn-primary' %>
      <% end %>
    </div>
  </div>

  <div class="my-schedule card mb-4">
    <div class="card-body">
      <h3>Моё расписание</h3>

      <% if @schedule.any? %>
        <div class="accordion" id="scheduleAccordion">
          <% (1..5).each do |day| %>
            <% day_slots = @schedule.select { |slot| slot.weekday == day } %>
            <% if day_slots.any? %>
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading<%= day %>">
                  <button class="accordion-button <%= day != 1 ? 'collapsed' : '' %>" type="button"
                          data-bs-toggle="collapse" data-bs-target="#collapse<%= day %>">
                    <% if day == 1 %>
                      Понедельник
                    <% elsif day == 2 %>
                      Вторник
                    <% elsif day == 3 %>
                      Среда
                    <% elsif day == 4 %>
                      Четверг
                    <% elsif day == 5 %>
                      Пятница
                    <% else %>
                      День <%= day %>
                    <% end %>
                    <span class="badge bg-primary ms-2"><%= day_slots.count %> занятий</span>
                  </button>
                </h2>
                <div id="collapse<%= day %>" class="accordion-collapse collapse <%= day == 1 ? 'show' : '' %>"
                     data-bs-parent="#scheduleAccordion">
                  <div class="accordion-body">
                    <table class="table">
                      <thead>
                      <tr>
                        <th>Время</th>
                        <th>Курс</th>
                        <th>Тип</th>
                        <th>Аудитория</th>
                      </tr>
                      </thead>
                      <tbody>
                      <% day_slots.sort_by(&:start_time).each do |slot| %>
                        <tr>
                          <td><%= slot.start_time.strftime('%H:%M') %> - <%= slot.end_time.strftime('%H:%M') %></td>
                          <td><%= link_to slot.course.name, slot.course %></td>
                          <td><span class="badge bg-info"><%= slot.lesson_type %></span></td>
                          <td><%= slot.classroom.building %>, ауд. <%= slot.classroom.number %></td>
                        </tr>
                      <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <p>У вас пока нет занятий в расписании.</p>
      <% end %>
    </div>
  </div>

  <div class="action-buttons">
    <%= link_to 'Посмотреть все курсы', courses_path, class: 'btn btn-primary me-2' %>
    <% if current_user.student_profile %>
      <%= link_to 'Редактировать профиль', edit_student_profile_path, class: 'btn btn-secondary' %>
    <% else %>
      <%= link_to 'Создать профиль', new_student_profile_path, class: 'btn btn-secondary' %>
    <% end %>
  </div>
</div>